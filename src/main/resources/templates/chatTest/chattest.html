<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket ì±„íŒ…</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        #chat-window {
            border: 1px solid #ccc;
            height: 500px;
            margin-bottom: 10px;
            overflow-y: auto;
            padding: 10px;
            background: #f9f9f9;
        }
        #message-list {
            list-style-type: none;
            padding: 0;
        }
        .file-drop-area {
            border: 2px dashed #4CAF50;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            margin-bottom: 10px;
            color: #333;
            transition: border 0.3s;
        }
        .message-image {
            max-width: 250px;
            max-height: 250px;
            border-radius: 5px;
            display: block;
            margin-top: 5px;
        }
        .image-preview img {
            max-width: 100px;
            max-height: 100px;
            border-radius: 5px;
            margin: 5px;
        }
        #selectedImages {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
    </style>
</head>
<body>

<h2>WebSocket ì±„íŒ… (ë¡œê·¸ì¸ ì—†ì´ í…ŒìŠ¤íŠ¸)</h2>

<div class="mb-3">
    <label>ë‚´ ì‚¬ìš©ì ID:</label>
    <input type="number" id="userId" class="form-control" placeholder="ë‚´ ì‚¬ìš©ì ID ì…ë ¥">
</div>
<div class="mb-3">
    <label>ìƒëŒ€ë°© ì‚¬ìš©ì ID:</label>
    <input type="number" id="otherUserId" class="form-control" placeholder="ìƒëŒ€ ì‚¬ìš©ì ID ì…ë ¥">
    <button class="btn btn-primary mt-2" onclick="createChatRoom()">ì±„íŒ…ë°© ìƒì„± ë° ì—°ê²°</button>
</div>

<div id="room-info" class="alert alert-info d-none">
    í˜„ì¬ ì±„íŒ…ë°© ID: <span id="currentRoomIdDisplay"></span>
</div>

<div id="chat-window">
    <ul id="message-list"></ul>
</div>

<!-- íŒŒì¼ ë“œë˜ê·¸ì•¤ë“œë¡­ + í´ë¦­ ê°€ëŠ¥ -->
<div id="fileDropArea" class="file-drop-area" onclick="openFilePicker()" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
    íŒŒì¼ì„ í´ë¦­í•˜ê±°ë‚˜ ë“œë˜ê·¸í•˜ì„¸ìš”
</div>
<input type="file" id="fileInput" style="display: none;" accept="image/*" multiple onchange="handleFileSelect(event)">

<!-- ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° -->
<div id="imagePreview" class="image-preview">
    <p>ì²¨ë¶€ëœ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°:</p>
    <div id="selectedImages"></div>
</div>

<!-- ì…ë ¥ & ì „ì†¡ -->
<div class="input-container d-flex align-items-center mt-2">
    <div id="message" class="form-control me-2" contenteditable="true" onclick="clearPlaceholder()" style="flex-grow: 1;">
        ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”
    </div>
    <button id="sendButton" class="btn btn-success" onclick="sendMessage()">ì „ì†¡</button>
</div>

<script>
    let stompClient = null;
    let currentRoomId = null;
    let userId = null;
    let selectedFiles = [];

    function connect(chatRoomId) {
        const socket = new SockJS("/ws");
        stompClient = Stomp.over(socket);

        stompClient.connect({}, function () {
            stompClient.subscribe("/topic/chat." + chatRoomId, function (message) {
                showMessage(JSON.parse(message.body));
            });

            document.getElementById("room-info").classList.remove("d-none");
            document.getElementById("currentRoomIdDisplay").textContent = chatRoomId;
        });
    }

    function createChatRoom() {
        userId = document.getElementById("userId").value;
        const otherUserId = document.getElementById("otherUserId").value;

        fetch(`/api/chat/rooms?userId1=${userId}&userId2=${otherUserId}`, { method: 'POST' })
            .then(res => res.json())
            .then(chatRoom => {
                currentRoomId = chatRoom.id;
                connect(currentRoomId);
            });
    }
    
    function sendChatMessage(type, content) {
        if (Array.isArray(content)) {
            content = content.join(",");  // ë°°ì—´ì„ ì‰¼í‘œë¡œ êµ¬ë¶„ëœ ë¬¸ìì—´ë¡œ ë³€í™˜
            console.log("ğŸ“© WebSocket ì „ì†¡ (ì‰¼í‘œ êµ¬ë¶„ëœ ì´ë¯¸ì§€ ë¦¬ìŠ¤íŠ¸):", { type, content });
        } else if (typeof content === "string" && content.trim() !== "") {
            content = content.trim();
            console.log("ğŸ“© WebSocket ì „ì†¡ (í…ìŠ¤íŠ¸ ë©”ì‹œì§€):", { type, content });
        } else {
            console.error("âŒ ë©”ì‹œì§€ ë‚´ìš©ì´ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            return;
        }

        stompClient.send("/app/chat.sendMessage", {}, JSON.stringify({
            senderId: userId,
            chatRoomId: currentRoomId,
            messageType: type,
            content: content  // ë¬¸ìì—´ë¡œ ë³€í™˜ëœ ë°ì´í„° ì „ì†¡
        }));
    }

    function sendMessage() {
        if (!stompClient || !currentRoomId || !userId) {
            alert("ì±„íŒ…ë°©ì„ ë¨¼ì € ìƒì„±í•˜ì„¸ìš”.");
            return;
        }

        const messageContent = document.getElementById("message").innerText.trim();
        const files = [...selectedFiles];  // ê¸°ì¡´ ë°°ì—´ì„ ë³µì‚¬ (forEach ì¤‘ ë°°ì—´ ë³€ê²½ ë°©ì§€)

        if (files.length > 0) {
            let uploadedImageUrls = [];
            let uploadCount = 0;

            files.forEach(file => {
                uploadImage(file, (imageUrl) => {
                    uploadedImageUrls.push(imageUrl);
                    uploadCount++;

                    // ëª¨ë“  ì´ë¯¸ì§€ ì—…ë¡œë“œê°€ ì™„ë£Œë˜ì—ˆì„ ë•Œ ë©”ì‹œì§€ ì „ì†¡
                    if (uploadCount === files.length) {
                        sendChatMessage("IMAGE", uploadedImageUrls);
                        if (messageContent) {
                            sendChatMessage("TEXT", messageContent);
                        }
                    }
                });
            });
        } else if (messageContent) {
            sendChatMessage("TEXT", messageContent);
        }

        document.getElementById("message").innerText = "";
        selectedFiles = [];
        document.getElementById("selectedImages").innerHTML = "";
    }


    function uploadImage(file, callback) {
        const formData = new FormData();
        formData.append("file", file);
        formData.append("roomId", currentRoomId);
        formData.append("senderId", userId);

        fetch("/api/chat/upload", { method: "POST", body: formData })
            .then(response => response.text())
            .then(imageUrl => {
                console.log("âœ… ì—…ë¡œë“œëœ ì´ë¯¸ì§€ URL:", imageUrl);
                callback(imageUrl);
            })
            .catch(err => console.error("âŒ ì—…ë¡œë“œ ì‹¤íŒ¨:", err));
    }

    function handleFileSelect(event) {
        selectedFiles = Array.from(event.target.files);
        updateImagePreview();
    }

    function handleDrop(event) {
        event.preventDefault();
        selectedFiles = Array.from(event.dataTransfer.files);
        updateImagePreview();
    }

    function handleDragOver(event) {
        event.preventDefault();
    }
    
    function clearPlaceholder() {
        const messageDiv = document.getElementById("message");

        if (messageDiv.innerText === "ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”") {
            messageDiv.innerText = "";
        }
    }

    function updateImagePreview() {
        const previewContainer = document.getElementById("selectedImages");
        previewContainer.innerHTML = "";

        selectedFiles.forEach(file => {
            const img = document.createElement("img");
            img.classList.add("image-preview");
            img.src = URL.createObjectURL(file);
            previewContainer.appendChild(img);
        });
    }

    function showMessage(message) {
        const messageList = document.getElementById("message-list");
        const li = document.createElement("li");
        li.dataset.messageId = message.id; // ë©”ì‹œì§€ ID ì €ì¥ (ì½ìŒ ì²˜ë¦¬ì— í•„ìš”)

        // ë³´ë‚¸ ì‚¬ëŒ ì •ë³´ ì¶”ê°€
        const senderInfo = document.createElement("div");
        senderInfo.innerText = `${message.senderName || "ì‚¬ìš©ì #" + message.senderId}: `;
        senderInfo.style.fontWeight = "bold";
        senderInfo.style.marginBottom = "5px";
        li.appendChild(senderInfo);

        // ì½ìŒ ì‹œê°„ í‘œì‹œí•  ìš”ì†Œ ìƒì„±
        const readTimeSpan = document.createElement("span");
        readTimeSpan.style.fontSize = "12px";
        readTimeSpan.style.color = "gray";
        readTimeSpan.style.marginLeft = "10px";

        if (message.readTime) {
            const formattedDate = new Date(message.readTime).toISOString().split("T")[0].replace(/-/g, ".");
            readTimeSpan.innerText = formattedDate;
        }

        if (message.messageType === "IMAGE") {
            const images = message.content.split(",").map(img => img.trim());

            const imageContainer = document.createElement("div");
            imageContainer.style.display = "flex";
            imageContainer.style.flexDirection = "column";
            imageContainer.style.alignItems = "center";
            imageContainer.style.marginBottom = "10px";

            // ë©”ì¸ ì´ë¯¸ì§€ (í° ì´ë¯¸ì§€)
            const mainImage = document.createElement("img");
            mainImage.src = images[0];
            mainImage.classList.add("message-image");
            mainImage.style.cursor = "pointer";
            mainImage.style.marginBottom = "8px";
            mainImage.onclick = () => showImageModal(images);

            imageContainer.appendChild(mainImage);

            // ì¸ë„¤ì¼ ì»¨í…Œì´ë„ˆ (ì‘ì€ ì´ë¯¸ì§€ë“¤)
            if (images.length > 1) {
                const thumbnailContainer = document.createElement("div");
                thumbnailContainer.style.display = "flex";
                thumbnailContainer.style.gap = "5px";
                thumbnailContainer.style.justifyContent = "center";
                thumbnailContainer.style.marginTop = "8px"; // â­ ì¸ë„¤ì¼ì„ ì•„ë˜ë¡œ ë°°ì¹˜ â­

                images.slice(1).forEach((src, index) => {
                    const thumb = document.createElement("img");
                    thumb.src = src;
                    thumb.style.width = "50px";
                    thumb.style.height = "50px";
                    thumb.style.borderRadius = "5px";
                    thumb.style.cursor = "pointer";
                    thumb.style.objectFit = "cover";
                    thumb.onclick = () => showImageModal(images, index + 1);
                    thumbnailContainer.appendChild(thumb);
                });

                // **ì¸ë„¤ì¼ì„ í° ì´ë¯¸ì§€ ì•„ë˜ë¡œ ë°°ì¹˜**
                imageContainer.appendChild(thumbnailContainer);
            }

            li.appendChild(imageContainer);
        } else {
            li.innerText = `${message.senderName || "ì‚¬ìš©ì #" + message.senderId}: ${message.content}`;
        }

        // ì½ìŒ ì‹œê°„ ì¶”ê°€
        li.appendChild(readTimeSpan);
        messageList.appendChild(li);
        document.getElementById("chat-window").scrollTop = document.getElementById("chat-window").scrollHeight;
    }

    function showImageModal(images, startIndex = 0) {
        const modal = document.createElement("div");
        modal.classList.add("image-modal");
        modal.style.position = "fixed";
        modal.style.top = "0";
        modal.style.left = "0";
        modal.style.width = "100vw";
        modal.style.height = "100vh";
        modal.style.background = "rgba(0,0,0,0.8)";
        modal.style.display = "flex";
        modal.style.alignItems = "center";
        modal.style.justifyContent = "center";
        modal.style.flexDirection = "column";
        modal.style.zIndex = "1000";

        let currentIndex = startIndex;

        // ë©”ì¸ ì´ë¯¸ì§€
        const img = document.createElement("img");
        img.src = images[currentIndex];
        img.style.maxWidth = "80%";
        img.style.maxHeight = "80%";
        img.style.borderRadius = "5px";

        // ì¢Œìš° ì´ë™ ë²„íŠ¼
        const prevBtn = document.createElement("button");
        prevBtn.innerText = "â†";
        prevBtn.style.position = "absolute";
        prevBtn.style.left = "20px";
        prevBtn.style.fontSize = "24px";
        prevBtn.style.background = "transparent";
        prevBtn.style.color = "white";
        prevBtn.style.border = "none";
        prevBtn.style.cursor = "pointer";
        prevBtn.style.padding = "10px";
        prevBtn.onclick = () => {
            if (currentIndex > 0) {
                currentIndex--;
                img.src = images[currentIndex];
            }
        };

        const nextBtn = document.createElement("button");
        nextBtn.innerText = "â†’";
        nextBtn.style.position = "absolute";
        nextBtn.style.right = "20px";
        nextBtn.style.fontSize = "24px";
        nextBtn.style.background = "transparent";
        nextBtn.style.color = "white";
        nextBtn.style.border = "none";
        nextBtn.style.cursor = "pointer";
        nextBtn.style.padding = "10px";
        nextBtn.onclick = () => {
            if (currentIndex < images.length - 1) {
                currentIndex++;
                img.src = images[currentIndex];
            }
        };

        // ë‹«ê¸° ë²„íŠ¼
        const closeButton = document.createElement("button");
        closeButton.innerText = "ë‹«ê¸°";
        closeButton.style.position = "absolute";
        closeButton.style.top = "20px";
        closeButton.style.right = "20px";
        closeButton.style.padding = "10px";
        closeButton.style.background = "white";
        closeButton.style.border = "none";
        closeButton.style.cursor = "pointer";
        closeButton.onclick = () => modal.remove();

        modal.appendChild(closeButton);
        modal.appendChild(prevBtn);
        modal.appendChild(img);
        modal.appendChild(nextBtn);
        document.body.appendChild(modal);
    }

    function openFilePicker() {
        document.getElementById("fileInput").click();
    }
    
    document.addEventListener("keydown", function(event) {
        const messageDiv = document.getElementById("message");

        if (event.key === "Enter" && !event.shiftKey) { 
            event.preventDefault();  // ê¸°ë³¸ ë™ì‘(ì¤„ë°”ê¿ˆ) ë°©ì§€
            sendMessage();  // ë©”ì‹œì§€ ì „ì†¡
        }
    });
    
    function markMessageAsRead(messageId) {
        fetch(`/api/chat/read/${messageId}?userId=${userId}`, { method: "POST" })
            .then(response => {
                if (response.ok) {
                    console.log(`âœ… ë©”ì‹œì§€ ${messageId} ì½ìŒ ì²˜ë¦¬ ì™„ë£Œ`);
                }
            })
            .catch(err => console.error("âŒ ì½ìŒ ì²˜ë¦¬ ì‹¤íŒ¨:", err));
    }

    // ì½ìŒ ê°ì§€ ë¡œì§
    function checkMessagesRead() {
        const messages = document.querySelectorAll("#message-list li");

        messages.forEach(li => {
            if (isElementInViewport(li)) {
                const messageId = li.dataset.messageId;
                if (messageId) {
                    markMessageAsRead(messageId);
                }
            }
        });
    }

    // ë©”ì‹œì§€ê°€ í™”ë©´ì— ë³´ì´ëŠ”ì§€ í™•ì¸
    function isElementInViewport(el) {
        const rect = el.getBoundingClientRect();
        return rect.top >= 0 && rect.bottom <= window.innerHeight;
    }

    // ìŠ¤í¬ë¡¤í•  ë•Œ ì½ìŒ ì²˜ë¦¬ ì‹¤í–‰
    document.getElementById("chat-window").addEventListener("scroll", checkMessagesRead);

    
    document.addEventListener("keydown", function (event) {
        if (event.ctrlKey && event.key.toLowerCase() === "q") {  
            event.preventDefault(); 
            document.getElementById("fileInput").click();  
        } else if (event.key === "Enter" && !event.shiftKey) {  
            event.preventDefault();  
            sendMessage();  
        }
    });

    document.addEventListener("paste", function (event) {
        let items = (event.clipboardData || event.originalEvent.clipboardData).items;
        for (let item of items) {
            if (item.kind === "file") {
                let file = item.getAsFile();
                if (file.type.startsWith("image/")) {
                    selectedFiles.push(file);
                    updateImagePreview();
                }
            }
        }
    });


    
</script>

</body>
</html>
