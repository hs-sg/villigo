<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{/layout/fragments :: htmlHead('빌리고｜마이페이지','/css/mypage.css')}">
</head>
<body>
    <th:block th:replace="~{/layout/fragments :: commonLayout}"></th:block>
    <main class="container-global">
        <div class="profile-container">
          <div class="profile-left">
            <div class="profile-img">
              <img id="profileImage" th:src="@{/images/testuser.jfif}" alt="프로필 이미지">
            </div>
            <div class="profile-info">
              <div class="nickname">피카츄</div>
              <div class="store-meta">
                <div class="meta-item">
                  <div class="meta-unit">
                    <span class="emoji-jjam">💎</span>
                    <span><strong>50</strong></span>
                  </div>
                  <div class="meta-unit">
                    <span class="emoji">📍</span>
                    <span>서울 강남구</span>
                  </div>
                  <div class="meta-unit">
                    <span class="emoji">🏷️</span>
                    <span>관심 상품 : 자동차</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <button class="edit-btn" onclick="location.href='/member/modify'">정보 수정</button>
        </div>

        <div class="tabs">
          <div class="tab active" id="myProductTab" onclick="showTab(0)">내상품</div>
          <div class="tab" onclick="showTab(1)">예약현황</div>
          <div class="tab" onclick="showTab(2)">나의예약</div>
          <div class="tab" id="likeProductTab" onclick="showTab(3)">찜</div>
          <div class="tab" onclick="showTab(4)">후기</div>
        </div>

        <!-- 내상품 탭 -->
        <div class="tab-content active">
            <h3>내상품</h3>
            <div class="product-wrapper" id="myProductDiv"></div>
            <div id="divMoreView"></div>
        </div>

        <!-- 예약 현황 탭 -->
        <div class="tab-content">
          <h3>예약 현황</h3>
            <div id="reservationReqList" class="reservation-list">
              </div>
              <!-- 예약 현황 더보기 버튼 요소 -->
              <div class="mt-4 d-flex justify-content-center" id="divMore">
                <button class="btn btn-outline-secondary" 
                  id="btnMore" style="display:none;">더보기 +</button>
            </div>
        </div>

        <!-- 나의 예약 탭 -->
        <div class="tab-content">
          <h3>나의 예약</h3>
          <div class="reservation-list">
            <div th:if="${#lists.isEmpty(myReservations)}">
              <p>예약이 없습니다.</p>
            </div>
          		<div class="reservation-card" th:each="reservation : ${myReservations}">
				  <div class="res-img">
				    <a th:href="@{|/post/details/${reservation.rentalCategoryId == 1 ? 'bag' : 'car'}?id=${reservation.productId}|}">
				      <img th:src="@{|/images/rentals/${reservation.imagePath != null ? reservation.imagePath : 'default.jpg'}|}" alt="상품 이미지" />
				    </a>
				  </div>
				  <div class="res-info">
				    <p class="car-name">
				      <a th:href="@{|/post/details/${reservation.rentalCategoryId == 1 ? 'bag' : 'car'}?id=${reservation.productId}|}">
				        <strong th:text="${reservation.productName} ?: '상품 이름 없음'"></strong>
				      </a>
				    </p>
				    <!-- 나머지 예약 정보 출력 -->
				    <p><strong>대여 날짜:</strong> <span th:text="${reservation.rentalDate} ?: '날짜 없음'"></span></p>
				    <p><strong>대여 시간:</strong> <span th:text="${reservation.rentalTimeRange} ?: '시간 없음'"></span></p>
				    <p><strong>요금:</strong> <span th:text="${#numbers.formatInteger(reservation.fee, 3, 'COMMA')} + ' JJAM' ?: '요금 없음'"></span></p>
				                <!-- 상태바 -->
				<div class="status-container">
				  <div class="status-line"></div>
				  <div class="status-steps">
				    <div class="step" th:classappend="${reservation.status == 0 ? 'completed' : ''}">
				      <div class="dot"></div>
				      <span>예약신청</span>
				    </div>
				    <div class="step" th:classappend="${(reservation.status == 0 or reservation.status == 1) ? 'completed' : ''}">
				      <div class="dot"></div>
				      <span>대기중</span>
				    </div>
				    <div class="step" th:classappend="${reservation.status == 2 ? 'completed' : ''}">
				      <div class="dot"></div>
				      <span>거래중</span>
				    </div>
				    <div class="step" th:classappend="${reservation.status == 3 ? 'completed' : ''}">
				      <div class="dot"></div>
				      <span>거래완료</span>
				    </div>
				    <div class="step reject" th:classappend="${reservation.status == 4 ? 'completed' : ''}">
				      <div class="dot"></div>
				      <span>거절됨</span>
				    </div>
				  </div>
				</div>

                <input type="hidden" class="reservation-status" th:value="${reservation.status} ?: 0" />

                <!-- 채팅/거래완료 버튼 -->
                <div class="res-buttons deal-buttons" th:style="${reservation.status == 2} ? 'display: flex' : 'display: none'">
                  <button class="btn-chat" onclick="location.href='/chat'">채팅</button>
                  <button class="btn-complete" onclick="openCompletePopup()">거래완료</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="tab-content tab-like">
            <h3>찜 목록</h3>
            <div class="product-wrapper" id="likeProductDiv"></div>
            <div id="divMoreView"></div>
        </div>

        <!-- 상점 후기 탭 -->
        <div class="tab-content">
          <h3>상점 후기</h3>
          <div th:if="${#lists.isEmpty(reviews)}">
            <p>후기가 없습니다.</p>
          </div>
          <div class="review-item" th:each="review : ${reviews}">
            <div class="review-user-info">
              <div class="review-user-img">
                <img th:src="@{'/images/' + ${review.userImage} ?: 'testuser2.jpg'}" alt="사용자 프로필">
              </div>
              <div class="review-user-meta">
                <a th:href="@{'/user/detail?id=' + ${review.userId}}" class="review-user-name" th:text="${review.userName} ?: '익명'">피리</a>
                <div class="review-score" th:text="${'⭐️'.repeat(review.score)} + ' (' + ${review.score} + '점)'">⭐️⭐️⭐️⭐️⭐️ (5점)</div>
              </div>
            </div>
            <div class="review-content" th:text="${review.content} ?: '리뷰 내용 없음'">
              "정말 친절하고 빠른 거래 감사합니다!"
            </div>
          </div>
        </div>
    </main>
    <th:block th:replace="~{/layout/fragments :: bootstrapJS}"></th:block>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script th:src="@{/js/mypage.js}"></script>
    <script th:src="@{/js/my-product.js}"></script>
    <script th:src="@{/js/mypage-reservationReqList.js}"></script>
</body>
</html>